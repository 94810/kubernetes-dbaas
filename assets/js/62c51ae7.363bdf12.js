"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[472],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return g}});var r=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,i=function(e,t){if(null==e)return{};var n,r,i={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=r.createContext({}),u=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=u(e.components);return r.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,i=e.mdxType,a=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),d=u(n),g=i,h=d["".concat(l,".").concat(g)]||d[g]||p[g]||a;return n?r.createElement(h,o(o({ref:t},c),{},{components:n})):r.createElement(h,o({ref:t},c))}));function g(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var a=n.length,o=new Array(a);o[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:i,o[1]=s;for(var u=2;u<a;u++)o[u]=n[u];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},617:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return l},metadata:function(){return u},toc:function(){return c},default:function(){return d}});var r=n(7462),i=n(3366),a=(n(7294),n(3905)),o=["components"],s={sidebar_position:3},l="Testing",u={unversionedId:"contributing/testing",id:"contributing/testing",isDocsHomePage:!1,title:"Testing",description:"Overview",source:"@site/docs/contributing/testing.md",sourceDirName:"contributing",slug:"/contributing/testing",permalink:"/kubernetes-dbaas/docs/contributing/testing",editUrl:"https://github.com/bedag/kubernetes-dbaas/edit/main/website/docs/contributing/testing.md",version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3},sidebar:"tutorialSidebar",previous:{title:"Architecture",permalink:"/kubernetes-dbaas/docs/contributing/architecture"},next:{title:"CI pipeline",permalink:"/kubernetes-dbaas/docs/contributing/ci"}},c=[{value:"Overview",id:"overview",children:[]},{value:"How-to",id:"how-to",children:[{value:"Setup DBMS",id:"setup-dbms",children:[]},{value:"Test configuration",id:"test-configuration",children:[]},{value:"Executing the test suite",id:"executing-the-test-suite",children:[]},{value:"Writing tests",id:"writing-tests",children:[]}]}],p={toc:c};function d(e){var t=e.components,n=(0,i.Z)(e,o);return(0,a.kt)("wrapper",(0,r.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"testing"},"Testing"),(0,a.kt)("h2",{id:"overview"},"Overview"),(0,a.kt)("p",null,"Testing is achieved by using ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/onsi/ginkgo"},"Ginkgo"),", a Behavior-Driven Development\ntesting framework."),(0,a.kt)("p",null,"There are 3 types of tests:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Unit"),(0,a.kt)("li",{parentName:"ul"},"Integration"),(0,a.kt)("li",{parentName:"ul"},"End-to-end (e2e)")),(0,a.kt)("p",null,"Unit tests do not interact with any external service, and the data used for testing is composed by simple\nstubs which are compared to the output of the tested components."),(0,a.kt)("p",null,"Integration tests interact with one external service, e.g. a DBMS."),(0,a.kt)("p",null,"E2e are a form of integration testing, which includes the interaction with the Kubernetes API.\nEnd-to-end tests are created using ",(0,a.kt)("a",{parentName:"p",href:"https://sdk.operatorframework.io/docs/building-operators/golang/testing/"},"envtest"),"\nwhich allows running a minimal\ncluster by providing kube-apiserver, kubectl and etcd binaries. This means also that there\naren\u2019t other controllers for built-in resources, for example it is not possible to test if a Secret is successfully\ngarbage-collected after deleting a Database resource because there is no controller controller watching for\nSecret deletion, which on the other hand would be the case for a standard cluster installation."),(0,a.kt)("h2",{id:"how-to"},"How-to"),(0,a.kt)("p",null,"The whole test suite is executed when commits are pushed to the main branch (see ",(0,a.kt)("a",{parentName:"p",href:"/docs/contributing/ci"},"CI pipeline"),"),\nbut it is much faster to execute it locally during development. "),(0,a.kt)("h3",{id:"setup-dbms"},"Setup DBMS"),(0,a.kt)("p",null,"First, you need to have the supported DBMS available for testing. You can start a few Docker containers for those. See\nthe following snippet:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'docker run -p 3306:3306 --name mariadb -e \'MARIADB_ROOT_PASSWORD=Password&1\' -d mariadb\ndocker run -e "ACCEPT_EULA=Y" -e "SA_PASSWORD=Password&1" -p 1433:1433 --name sqlserver -h sqlserver -d mcr.microsoft.com/mssql/server:2019-latest\ndocker run --name psql1 -p 5432:5432 -e POSTGRES_PASSWORD="Password&1" -d postgres\n')),(0,a.kt)("p",null,"Simply use an ETL tool such as DBeaver or HeidiSQL to load all the stored procedures contained in the\n",(0,a.kt)("inlineCode",{parentName:"p"},"testdata/procedures")," folder."),(0,a.kt)("h3",{id:"test-configuration"},"Test configuration"),(0,a.kt)("p",null,"Next, you need to create a test configuration. You can find an example ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/bedag/kubernetes-dbaas/tree/main/testdata"},"here"),"\nalong with all the resources and stored procedure you might need. "),(0,a.kt)("p",null,"Tweak the configuration based on what you want to test\nalong with the necessary DatabaseClasses and credentials for the DB systems. You can find the sample resources in the\n",(0,a.kt)("inlineCode",{parentName:"p"},"testdata/resources")," folder."),(0,a.kt)("p",null,"Now, specify the full path of your testing configuration by setting the ",(0,a.kt)("inlineCode",{parentName:"p"},"TEST_CONFIG_PATH")," environment variable."),(0,a.kt)("h3",{id:"executing-the-test-suite"},"Executing the test suite"),(0,a.kt)("p",null,"The first time it is advised to run ",(0,a.kt)("inlineCode",{parentName:"p"},"make test"),", which will install the necessary envtest binaries and start\nthe test suite, afterwards the Ginkgo CLI can be used directly:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"ginkgo -r -v\n")),(0,a.kt)("p",null,"Alternatively, you can make use of a cluster installation of your choice by setting the ",(0,a.kt)("inlineCode",{parentName:"p"},"TEST_USE_EXISTING_CLUSTER")," environment\nvariable to ",(0,a.kt)("inlineCode",{parentName:"p"},"true"),", in this case the predefined cluster installation will be used, e.g. your local Minikube instance, and\nyou will need to load the CRDs via ",(0,a.kt)("inlineCode",{parentName:"p"},"make install"),"."),(0,a.kt)("p",null,"Unit and integration tests can be executed in parallel by using the ",(0,a.kt)("inlineCode",{parentName:"p"},"-p")," option of Ginkgo.\nIt is possible to focus on the desired test suite portion by using regex:"),(0,a.kt)("p",null,"To run only integration tests in the ",(0,a.kt)("inlineCode",{parentName:"p"},"database")," package:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'ginkgo -focus=".*[i]*." -v pkg/database\n')),(0,a.kt)("p",null,"To run only unit tests in the ",(0,a.kt)("inlineCode",{parentName:"p"},"database")," package:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'ginkgo -focus=".*[u]*." -v pkg/database\n')),(0,a.kt)("p",null,"To run only e2e tests:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'ginkgo -focus=".*[e2e]*." -v\n')),(0,a.kt)("p",null,"To generate the test coverage report:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"ginkgo -v -r -cover -coverprofile=coverage.out -outputdir=testdata/cover\ngo tool cover -html=testdata/cover/coverage.out -o testdata/cover/coverage_report.html\n")),(0,a.kt)("h3",{id:"writing-tests"},"Writing tests"),(0,a.kt)("p",null,"It is advised to read ",(0,a.kt)("a",{parentName:"p",href:"https://book.kubebuilder.io/cronjob-tutorial/writing-tests.html"},"Writing controller tests")," on\nthe Kubebuilder docs for anything related to writing controller tests while using envtest."),(0,a.kt)("p",null,"There are no particular caveats, other than commenting each step of a test, especially if longer than a few lines, is pretty\nmuch required. "),(0,a.kt)("p",null,"One thing to keep in mind when writing tests, is to make use of the\n",(0,a.kt)("inlineCode",{parentName:"p"},"test.FormatTestName(label TestType, description string, extras ...TestAttribute)")," method to format the description of tests,\nthis way regex can be used to include or exclude test cases from execution. Refer to its godocs to learn more."))}d.isMDXComponent=!0}}]);